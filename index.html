<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>react</title>
    <style>
      .nav-con{transition:all ease 2s;border:1px solid red;}
      .nav-con-show,.news-con-show{display: block;}
      .nav-con-hide,.news-con-hide{display: none;}
      .news-list{width: 100%;overflow: hidden;border-bottom:1px solid #ccc;}
      .news-con{padding:20px 0;}
      .active .dropdown{display: none;}
    </style>
</head>
<body>
  <!-- 下拉菜单 -->
<div id="dropdown"></div>
<div id="container"></div>
<div class="nav"></div>

<div id="newslist"> </div>
<div id="mountNode"></div>
<div id="content"></div>
<div id="nav"></div>



<script src="/bower_components/react/react.min.js"></script>
<script src="/bower_components/react/react-dom.js"></script>
<script src="/bower_components/babel/browser.min.js"></script>
<script src="/bower_components/jquery/dist/jquery.min.js"></script>
<script src="/bower_components/marked/marked.min.js"></script>
<script type="text/babel">

//下拉弹窗
var text = "你好啊";
var title = "标题";
var dropArr = [
   {'id': 0, 'name' : '彭于晏' },
   {'id': 1, 'name' : '彭于晏' },
   {'id': 2, 'name' : '彭于晏' }
];

var Dropdown = React.createClass({

  propTypes:{
    text  :  React.PropTypes.string.isRequried,
    title :  React.PropTypes.string,
    option:  React.PropTypes.array.isRequired
  },

  getInitialState:function(){
      return {
        active : false
      };
  },

  //响应用户点击事件的回调函数
  toggleFold:function(){
     console.log(this.state.active);
     this.setState({
      active: !this.state.active
     });
   
  },

  render: function(){
    var optionsNodes = this.props.options.map(function(option){
      console.log(option)
          return (
            <li key={option.id}>{option.name}</li>
          );
        }
    );
    
    return (
      // 点击事件回调函数
      <div className={(this.state.active ? 'active' : '') +　" select"} onClick={this.toggleFold}> 
        {this.props.text}
        <div className="selector">
           <i className="icon-down">点击我</i>
        </div>
        <ul className="dropdown">{optionsNodes}</ul>
      </div>
    );


  }


});

 ReactDOM.render(<Dropdown text={text} title={title} options={dropArr} />, document.getElementById('dropdown'));

// 测试一下ES6 语法
// 测试一下 css-in-js 模式 
const divStyle = {
  color:'orange'
};

class WorldMessage extends React.Component{
    render(){
        return (
            <h3 style={divStyle}>
              {this.props.name}
            </h3>
        )
    }
}

var container = document.getElementById('container');
ReactDOM.render(<WorldMessage name="橙子新闻" />, container); 

// 测试一下ES6 语法结束



var NewsCon = React.createClass({
    render : function(){
      return (
        <div className="news-list">
          <h3 onClick={this.props.handleClick}>{this.props.dataInfo.title}</h3>
              <div className={this.props.showStatus ? 'news-con news-con-show' : 'news-con news-con-hide'}>
                     
                     <p>{this.props.dataInfo.abs}</p>
                     <p>
                      <span>{this.props.dataInfo.site}</span>
                     </p>
                   </div>
              </div> 
         );
    }
});

// 新闻列表，使用百度新闻静态json
var NewsList = React.createClass({
    //初始化组件状态，获取初始state
    getInitialState:function(){
      return {
        newsData:[],
        show: false,
        index:0
      };
    },
    // 组件点击事件
    handleClick:function(index, e){
      console.log(1);
      this.setState(
      {
        // show:!this.state.show,
        index: index

      });


    },
   // 组件被嵌入时，调用
   componentDidMount: function(){
     $.ajax({
        url:this.props.url,
        dataType:'json',
        cache:false,
        success:function(data){
          console.log(data.data.news);
          // 数据获取成功以后，设置组件state
          this.setState({newsData:data.data.news});
        }.bind(this),

        error:function(xhr, status, err){
          console.error(this.props.url, status, err.toString());
        }.bind(this)

      });
    },
   render : function() {
            var that = this;
            var stateData = this.state;
            var handleClick = this.handleClick;
            return (<div>
                 { //遍历newsData数组
                  this.state.newsData.map(function(res,index){
                    return (<NewsCon showStatus={that.state.index == index} handleClick={that.handleClick.bind(null,index)} dataInfo={res} key={index} />)
                  })
                }
              </div>)
            // return (<div className="accordion">
            //     {
            //       this.state.newsData.map(function(res, index) {
            //         return (<NewsCon showStatus={this.state.showStatus} handleClick={handleClick.bind(null,index)} dataInfo={res})
            //       }
            //     }
            // </div>);
        }
    // render:function(){
    //    console.log(this.state);
    //    // this.state.newsData.map(function(res){
    //     // var showStatus = this.state.show;
    //     // var handleClick= this.handleClick;
    //     // var newsNodes = this.state.newsData.map(function(res,index){
    //     //     return (
    //     //        <div className="news-list">
    //     //            <h3 data-num={index} onClick={handleClick}>{res.title}</h3>
    //     //            <div className={showStatus ? 'news-con news-con-show' : 'news-con news-con-hide'}>
                     
    //     //              <p>{res.abs}</p>
    //     //              <p>
    //     //               <span>{res.site}</span>
    //     //              </p>
    //     //            </div>
    //     //        </div> 
    //     //     )
    //     // });
        
    //     var showStatus = this.state.show;
    //     var handleClick= this.handleClick;
    //     var newsNodes = this.state.newsData.map(function(res,index){

    //         return(
    //            <NewsCon showStatus={showStatus} handleClick={handleClick.bind(null,index)} dataInfo={res} />
    //           )
    //     });


    //     return (
    //       <div>
    //        {newsNodes}
    //       </div>     
    //     )    
     
    // }


});


var Nav = React.createClass({
 //获取初始state数据
  getInitialState:function(){
      return {show: false};
    },
  //组件上h4 点击事件
  handleClick:function(){
    console.log(this.state);
    this.setState({
      show: !this.state.show
    })
  },
  //渲染 
  //className={this.state.show ? 'nav-con-show' : 'nav-con-hide'}
  //根据state数据 show的值，切换类
  render : function(){
    return (
        <div>
          <h4 onClick={this.handleClick}>菜单</h4>
          <div className={this.state.show ? 'nav-con nav-con-show' : 'nav-con nav-con-hide'}>
            内容
          </div>
        </div>
      );
  }

});
// 评论数据

// var data = [
//   {author : '胡歌', text : '御剑江湖'},
//   {author : '刘亦菲', text : '莫喜莫悲'}
// ];

// 评论列表组件
  var CommentList = React.createClass({

    render : function(){ //页面渲染，使用传入的数据进行渲染
      var commentNodes = this.props.data.map(function(comment){
        return (
         <Comment author={comment.author}>
          {comment.text}
         </Comment>
        )
      });

      return (
        <div className="commentList">
          {commentNodes}
        </div>
      );

    }

  });

// 评论表单组件
  var CommentForm = React.createClass({
    handleSubmit:function(e){  // 表单提交操作
      e.preventDefault();      //阻止默认行为
      var author = this.refs.author.value.trim();
      var text = this.refs.text.value.trim();
      if(!text || !author){            //简单的验证
        return;
      }

      this.props.onCommentSubmit({author:author,text:text});  //调用方法，向服务器发送数据
      this.refs.author.value = '';     //将表单清空
      this.refs.text.value= '';
      return;
    },
    render:function(){  //渲染表单组件
      return (
        <form className="commentForm" onSubmit={this.handleSubmit}>  
          <input type="text" placeholder="姓名" ref="author" />
          <input type="text" placeholder="评论内容" ref="text" />
          <input type="submit" value="发布"/>
        </form>
      );
    }
  });

// 评论内容组件
  var Comment = React.createClass({

    rawMarkup: function(){   //marked 操作
      var rawMarkup = marked(this.props.children.toString(),{sanitize:true});
      return {__html: rawMarkup};
    },

    render: function(){  //渲染 评论内容
      return (
        <div className="comment">
          <h3 className="commentAuthor">
            {this.props.author}
          </h3>
          <span dangerouslySetInnerHTML = {this.rawMarkup()} />
        </div>
      );
    }
  });

// 评论主体组件
  var CommentBox = React.createClass({
    //初始化组件状态
    getInitialState:function(){
      return {data:[]};
    },

    loadCommentsFromServer:function(){   //使用ajax方法从服务器获取 评论数据的方法

      $.ajax({
        url:this.props.url,
        dataType:'json',
        cache:false,
        success:function(data){
          console.log(data);
          this.setState({data:data});
        }.bind(this),

        error:function(xhr, status, err){
          console.error(this.props.url, status, err.toString());
        }.bind(this)

      });
    },

    handleCommentSubmit:function(comment){  //表单提交的方法，使用ajax
      var comments = this.state.data;
      var newComments = comments.concat([comment]);
      this.setState({data: newComments});
      $.ajax({
        url:this.props.url,
        dataType : 'json',
        type:'POST',
        data:comment,
        success:function(data){
          this.setState({data:data});
        }.bind(this),
        error:function(xhr, status, err){
          console.error(this.props.url, status, err.toString());
        }.bind(this)
      });

    },

    // 组件被嵌入之后，触发的方法，用于 向服务器请求数据
    componentDidMount: function(){
      this.loadCommentsFromServer();
      //setInterval(this.loadCommentsFromServer, this.props.pollInterval);//设置轮询
    },

    render: function(){  //渲染页面
      return (
        <div className="commentBox">
          <h1>评论</h1>
          <CommentList data={this.state.data}/>
          <CommentForm  onCommentSubmit={this.handleCommentSubmit}/>
        </div>
      );
    }
  });

  ReactDOM.render(<CommentBox url="/api/comments.json"  pollInterval={2000} />, document.getElementById('content'));

 ReactDOM.render(<Nav />, document.getElementById('nav'));
 ReactDOM.render(<NewsList url="/api/news.json" />, document.getElementById('newslist'));


</script>
</body>
</html>